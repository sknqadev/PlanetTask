name: Online Banking CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 23
        uses: actions/setup-java@v3
        with:
          java-version: '23'
          distribution: 'oracle'

      - name: Start mock-server
        run: |
          echo "🚀 Starting mock-server..."
          mvn clean compile
          mvn -pl mock-server exec:java -D="com.example.mock.MockServer"  -Dexec.args="start" &
          MOCK_PID=$!
          cd ..
          sleep 3

      - name: Build and run API tests
        run: |
          cd api-tests/ || exit 1
          mvn clean test -D allure.results.directory=../allure-results
          cd ..

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Playwright and run UI tests
        working-directory: ui-tests
        run: |
          npm ci
          npx playwright install
          npx playwright test
          cp -r allure-results/* ../allure-results/ 2>/dev/null || echo "⚠️ Nenhum resultado do Playwright encontrado."
          cd ..


      - name: Stopping mock-server
        run: |
          echo "🛑 Stopping mock-server..."
          kill "$MOCK_PID" || true


#      - name: Install JMeter and run load tests
#        run: |
#          sudo apt update && sudo apt install -y jmeter
#          jmeter -n -t load-tests/fund-transfer-load.jmx -l results.jtl
#
#      - name: Upload JMeter results
#        uses: actions/upload-artifact@v4
#        with:
#          name: jmeter-results
#          path: results.jtl
